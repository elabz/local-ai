# Langfuse LLM Observability Stack
#
# IMPORTANT: Before running, set the following in your .env file:
#   - LANGFUSE_DB_PASSWORD (generate with: openssl rand -base64 32)
#   - LANGFUSE_CLICKHOUSE_PASSWORD (generate with: openssl rand -base64 32)
#   - LANGFUSE_S3_ACCESS_KEY (generate with: openssl rand -base64 24)
#   - LANGFUSE_S3_SECRET_KEY (generate with: openssl rand -base64 32)
#   - LANGFUSE_NEXTAUTH_SECRET (generate with: openssl rand -hex 32)
#   - LANGFUSE_SALT (generate with: openssl rand -hex 32)
#
# Standalone deployment:
#   docker compose -f docker-compose.langfuse.yml up -d
#
# With HeartCode production stack:
#   docker compose -f docker-compose.yml -f docker-compose.langfuse.yml up -d

services:
  # =============================================================================
  # LANGFUSE CORE SERVICES
  # =============================================================================

  langfuse-web:
    image: langfuse/langfuse:3
    container_name: local-ai-langfuse-web
    restart: unless-stopped
    depends_on:
      langfuse-postgres:
        condition: service_healthy
      langfuse-clickhouse:
        condition: service_healthy
      langfuse-redis:
        condition: service_healthy
      langfuse-minio:
        condition: service_started
    environment:
      # Database
      - DATABASE_URL=postgresql://langfuse:${LANGFUSE_DB_PASSWORD:?LANGFUSE_DB_PASSWORD must be set}@langfuse-postgres:5432/langfuse

      # ClickHouse (single-node, no cluster)
      - CLICKHOUSE_URL=http://langfuse-clickhouse:8123
      - CLICKHOUSE_MIGRATION_URL=clickhouse://langfuse-clickhouse:9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${LANGFUSE_CLICKHOUSE_PASSWORD:?LANGFUSE_CLICKHOUSE_PASSWORD must be set}
      - CLICKHOUSE_CLUSTER_ENABLED=false

      # Redis (Langfuse's own instance)
      - REDIS_HOST=langfuse-redis
      - REDIS_PORT=6379
      - REDIS_AUTH=

      # S3/Minio for blob storage
      - LANGFUSE_S3_EVENT_UPLOAD_ENABLED=true
      - LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse
      - LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1
      - LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=${LANGFUSE_S3_ACCESS_KEY:?LANGFUSE_S3_ACCESS_KEY must be set}
      - LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=${LANGFUSE_S3_SECRET_KEY:?LANGFUSE_S3_SECRET_KEY must be set}
      - LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://langfuse-minio:9000
      - LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true

      # Auth
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET:?LANGFUSE_NEXTAUTH_SECRET must be set}
      - NEXTAUTH_URL=http://localhost:3002
      - SALT=${LANGFUSE_SALT:?LANGFUSE_SALT must be set}

      # Telemetry (disable if you prefer)
      - TELEMETRY_ENABLED=false

      # Features
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=false
    ports:
      - "3002:3000"
    networks:
      - langfuse
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.langfuse.rule=Host(`langfuse.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.langfuse.tls=true"
      - "traefik.http.services.langfuse.loadbalancer.server.port=3000"

  langfuse-worker:
    image: langfuse/langfuse-worker:3
    container_name: local-ai-langfuse-worker
    restart: unless-stopped
    depends_on:
      langfuse-postgres:
        condition: service_healthy
      langfuse-clickhouse:
        condition: service_healthy
      langfuse-redis:
        condition: service_healthy
    environment:
      # Database
      - DATABASE_URL=postgresql://langfuse:${LANGFUSE_DB_PASSWORD:?LANGFUSE_DB_PASSWORD must be set}@langfuse-postgres:5432/langfuse

      # ClickHouse (single-node, no cluster)
      - CLICKHOUSE_URL=http://langfuse-clickhouse:8123
      - CLICKHOUSE_MIGRATION_URL=clickhouse://langfuse-clickhouse:9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${LANGFUSE_CLICKHOUSE_PASSWORD:?LANGFUSE_CLICKHOUSE_PASSWORD must be set}
      - CLICKHOUSE_CLUSTER_ENABLED=false

      # Redis
      - REDIS_HOST=langfuse-redis
      - REDIS_PORT=6379
      - REDIS_AUTH=

      # S3/Minio
      - LANGFUSE_S3_EVENT_UPLOAD_ENABLED=true
      - LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse
      - LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1
      - LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=${LANGFUSE_S3_ACCESS_KEY:?LANGFUSE_S3_ACCESS_KEY must be set}
      - LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=${LANGFUSE_S3_SECRET_KEY:?LANGFUSE_S3_SECRET_KEY must be set}
      - LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://langfuse-minio:9000
      - LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true

      # Auth (must match web)
      - SALT=${LANGFUSE_SALT:?LANGFUSE_SALT must be set}
    networks:
      - langfuse

  # =============================================================================
  # LANGFUSE DATABASES
  # =============================================================================

  langfuse-postgres:
    image: postgres:16-alpine
    container_name: local-ai-langfuse-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=${LANGFUSE_DB_PASSWORD:?LANGFUSE_DB_PASSWORD must be set}
      - POSTGRES_DB=langfuse
    volumes:
      - langfuse_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - langfuse

  langfuse-clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: local-ai-langfuse-clickhouse
    restart: unless-stopped
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${LANGFUSE_CLICKHOUSE_PASSWORD:?LANGFUSE_CLICKHOUSE_PASSWORD must be set}
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
      - langfuse_clickhouse_logs:/var/log/clickhouse-server
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - langfuse

  langfuse-redis:
    image: redis:7-alpine
    container_name: local-ai-langfuse-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - langfuse_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - langfuse

  langfuse-minio:
    image: minio/minio:latest
    container_name: local-ai-langfuse-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${LANGFUSE_S3_ACCESS_KEY:?LANGFUSE_S3_ACCESS_KEY must be set}
      - MINIO_ROOT_PASSWORD=${LANGFUSE_S3_SECRET_KEY:?LANGFUSE_S3_SECRET_KEY must be set}
    volumes:
      - langfuse_minio_data:/data
    ports:
      - "9090:9000"   # S3 API
      - "9091:9001"   # Console
    networks:
      - langfuse

  # Minio bucket initialization
  langfuse-minio-init:
    image: minio/mc:latest
    container_name: local-ai-langfuse-minio-init
    depends_on:
      - langfuse-minio
    entrypoint: >
      /bin/sh -c "
        sleep 5;
        mc alias set myminio http://langfuse-minio:9000 ${LANGFUSE_S3_ACCESS_KEY:?LANGFUSE_S3_ACCESS_KEY must be set} ${LANGFUSE_S3_SECRET_KEY:?LANGFUSE_S3_SECRET_KEY must be set};
        mc mb myminio/langfuse --ignore-existing;
        exit 0;
      "
    networks:
      - langfuse

networks:
  langfuse:
    driver: bridge

volumes:
  langfuse_postgres_data:
  langfuse_clickhouse_data:
  langfuse_clickhouse_logs:
  langfuse_redis_data:
  langfuse_minio_data:
